<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lottery Pro Max - Smart Paste</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

<style>
    :root { --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --primary: #7b1fa2; --secondary: #00c853; --danger: #d32f2f; --border: #333; }
    body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 10px; }
    .card { width: 100%; max-width: 450px; background: var(--card-bg); border-radius: 15px; padding: 15px; box-sizing: border-box; }
    input, button, textarea, select { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #2c2c2c; color: white; outline: none; }
    .row { display: flex; gap: 5px; align-items: center; }
    button { font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; transition: 0.3s; }
    .tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; }
    .tab { padding: 8px 15px; background: #333; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; }
    .tab.active { background: var(--primary); color: white; }
    .list { margin-top: 10px; max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: #181818; }
    .item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); }
    .item-text { font-family: 'Courier New', Courier, monospace; font-size: 17px; font-weight: bold; color: #fff; white-space: nowrap; }
    .total-section { display: flex; justify-content: space-between; padding: 12px; background: #333; border-radius: 8px; margin-top: 10px; font-weight: bold; border: 1px solid var(--primary); }
    .hidden { display: none !important; }
    #loginOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#121212; z-index:9999; display:flex; justify-content:center; align-items:center; }
    #posSelect { width: 85px; background: #455a64; font-weight: bold; }
    .smart-box { background: #263238; padding: 10px; border-radius: 8px; border: 1px dashed var(--secondary); margin-top: 10px; }
</style>
</head>
<body onload="checkAutoLogin()">

<div id="loginOverlay">
    <div class="card" style="max-width:320px; text-align:center;">
        <h2 style="color:var(--primary);">Lottery Pro</h2>
        <input id="loginPhone" type="tel" placeholder="Mobile Number" style="text-align:center;">
        <button style="background:var(--primary); color:white;" onclick="checkLogin()">UNLOCK</button>
    </div>
</div>

<div class="screen hidden" id="mainPage">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <label for="scanInput" style="background:#e91e63; color:white; padding:8px 12px; border-radius:8px; font-size:11px; cursor:pointer;">üì∑ SCAN PHOTO</label>
            <input type="file" id="scanInput" style="display:none;" accept="image/*" capture="environment" onchange="scanImage(this)">
            <button onclick="loadRecentTab()" style="width:auto; font-size:10px; background:#f39c12; padding:5px 10px;">RECENT</button>
            <button onclick="logout()" style="width:auto; font-size:10px; background:#444; padding:5px 10px;">LOGOUT</button>
        </div>

        <div class="tabs" id="tabsList"></div>
        <input id="customer" placeholder="‡¥ï‡¥∏‡µç‡¥±‡µç‡¥±‡¥Æ‡µº ‡¥™‡µá‡¥∞‡µç" oninput="updateTabName()">
        
        <div class="row">
            <select id="posSelect" onchange="updateLimit()">
                <option value="ABC">ABC</option>
                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                <option value="AB">AB</option><option value="BC">BC</option><option value="AC">AC</option>
            </select>
            <input id="num" placeholder="No" maxlength="3" type="tel" style="flex:2;">
            <input id="endNum" class="hidden" placeholder="End" maxlength="3" type="tel" style="flex:2;">
            <input id="gap" class="hidden" placeholder="Gap" type="tel" style="flex:1;" value="1">
            <input id="count" placeholder="Count" type="tel" style="flex:2;">
        </div>

        <div class="row">
            <button id="addBtn" style="background:var(--primary); flex:2;" onclick="addEntry()">ADD</button>
            <button style="background:#546e7a; flex:1;" onclick="boxEntry()">BOX</button>
            <button id="stepToggle" style="background:#4527a0; flex:1;" onclick="toggleStepMode()">STEP</button>
        </div>

        <div class="list" id="liveList"></div>
        <div class="total-section"><span>TOTAL COUNT</span><span id="liveTotal">0</span></div>
        
        <div class="row">
            <button style="background:#25D366; flex: 2;" onclick="share()">WHATSAPP</button>
            <button style="background:#2e7d32; flex: 1;" onclick="saveDay()">SAVE</button>
        </div>
        
        <div class="row">
            <button style="background:#455a64; flex: 2;" onclick="openHistory()">HISTORY & MERGE</button>
            <button style="background:var(--danger); flex: 1;" onclick="resetTab()">CLEAR TAB</button>
        </div>

        <div class="smart-box">
            <textarea id="smartPasteArea" placeholder="‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ ‡¥™‡µá‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï (3-Digit ‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Ç ‡¥é‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥Ç)..." style="height: 60px; font-size: 13px; margin: 0;"></textarea>
            <button style="background:var(--secondary); padding: 8px; margin-top: 5px; font-size: 12px; width: 100%;" onclick="processSmartPaste()">SMART ADD (3-DIGIT ONLY)</button>
        </div>
    </div>
</div>

<div class="screen hidden" id="historyPage">
    <div class="card">
        <h3>History (Merge & Share)</h3>
        <div class="row">
            <input id="minLimit" type="number" placeholder="Min Count" style="flex:1; border: 1px solid var(--secondary);">
            <button style="background:var(--secondary); flex:1;" onclick="shareMerged()">WA SHARE</button>
        </div>
        <button style="background:#673AB7; margin-top:0;" onclick="renderSaved(true)">VIEW MERGED LIST</button>
        <div class="list" id="savedList"></div>
        <div class="total-section"><span>GRAND TOTAL</span><span id="savedTotal">0</span></div>
        <div class="row"><button style="background:#555;" onclick="backToMain()">BACK</button><button style="background:var(--danger);" onclick="clearAllHistory()">CLEAR ALL</button></div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://surajlott-4a0b6-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function checkAutoLogin() {
        const lastLogin = localStorage.getItem("login_time");
        if(lastLogin && (new Date().getTime() - lastLogin < 12 * 60 * 60 * 1000)) showMain();
    }
    function checkLogin() {
        const phone = document.getElementById("loginPhone").value.trim();
        db.ref('users/' + phone).once('value').then((snap) => {
            if(snap.val() && snap.val().status === 'active') {
                localStorage.setItem("login_time", new Date().getTime());
                showMain();
            } else { alert("‡¥Ö‡¥®‡µÅ‡¥Æ‡¥§‡¥ø‡¥Ø‡¥ø‡¥≤‡µç‡¥≤!"); }
        });
    }
    function showMain() { document.getElementById("loginOverlay").classList.add("hidden"); document.getElementById("mainPage").classList.remove("hidden"); initTabs(); }
    function logout() { localStorage.clear(); location.reload(); }

    let customers = JSON.parse(localStorage.getItem("lottery_customers")) || [{name: "", temp: []}];
    let activeIndex = 0;
    let permanent = JSON.parse(localStorage.getItem("perm_list")) || [];
    let isStepMode = false;

    // Smart Paste Logic
    function processSmartPaste() {
        let text = document.getElementById("smartPasteArea").value;
        if(!text) return;
        
        // Regex: Matches exactly 3 digits, followed by any non-digit separator, then digits (count)
        // This will find "123*2", "236 3", "475-5" but ignore "A-5 10" or "BC 22"
        let regex = /(?:^|[^\d])(\d{3})(?:[^\d]+)(\d+)(?=[^\d]|$)/g;
        let match;
        let addedCount = 0;

        while ((match = regex.exec(text)) !== null) {
            let num = match[1];
            let count = match[2];
            addManual("ABC", num, count);
            addedCount++;
        }

        if(addedCount > 0) {
            document.getElementById("smartPasteArea").value = "";
            alert(addedCount + " ‡¥®‡¥Æ‡µç‡¥™‡¥±‡µÅ‡¥ï‡µæ ‡¥Ü‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ.");
        } else {
            alert("3-Digit ‡¥®‡¥Æ‡µç‡¥™‡¥±‡µÅ‡¥ï‡µæ ‡¥í‡¥®‡µç‡¥®‡µÅ‡¥Ç ‡¥ï‡¥£‡µç‡¥ü‡µÜ‡¥§‡µç‡¥§‡¥æ‡¥®‡¥æ‡¥Ø‡¥ø‡¥≤‡µç‡¥≤.");
        }
    }

    document.getElementById("num").addEventListener("keyup", function(e) { 
        if(this.value.length === this.maxLength) document.getElementById(isStepMode ? "endNum" : "count").focus();
        if(e.key === "Enter") addEntry(); 
    });
    document.getElementById("endNum").addEventListener("keyup", function(e) { if(e.key === "Enter") document.getElementById("count").focus(); });
    document.getElementById("count").addEventListener("keyup", function(e) { if(e.key === "Enter") addEntry(); });

    function updateLimit() {
        let p = document.getElementById("posSelect").value;
        let n = document.getElementById("num");
        n.maxLength = (p === "ABC") ? 3 : (["AB","BC","AC"].includes(p) ? 2 : 1);
        n.focus();
    }

    function addEntry() {
        let n = document.getElementById("num").value, c = document.getElementById("count").value, p = document.getElementById("posSelect").value;
        if(!n || !c) return;
        if(isStepMode) {
            let end = document.getElementById("endNum").value, gap = parseInt(document.getElementById("gap").value) || 1;
            for(let i = parseInt(n); i <= parseInt(end); i += gap) addManual(p, i.toString(), c);
        } else addManual(p, n, c);
        document.getElementById("num").value = ""; document.getElementById("endNum").value = ""; document.getElementById("count").value = "";
        document.getElementById("num").focus();
    }

    function addManual(p, n, c) {
        let pad = (p === "ABC") ? 3 : (["AB","BC","AC"].includes(p) ? 2 : 1);
        customers[activeIndex].temp.push({p: p, n: n.padStart(pad, '0'), c: parseInt(c)});
        renderLive();
    }

    function renderLive() {
        let h = "", t = 0;
        customers[activeIndex].temp.slice().reverse().forEach((item, i) => {
            h += `<div class="item">
                    <span class="item-text">${item.p} ${item.n} -- ${item.c}</span>
                    <button onclick="deleteEntry(${customers[activeIndex].temp.length-1-i})" style="color:red; background:none; border:none; font-size:20px;">‚úñ</button>
                  </div>`;
            t += item.c;
        });
        document.getElementById("liveList").innerHTML = h || "<p style='text-align:center;'>No Data</p>";
        document.getElementById("liveTotal").innerText = t;
        localStorage.setItem("lottery_customers", JSON.stringify(customers));
    }

    function deleteEntry(idx) { if(confirm("‡¥°‡¥ø‡¥≤‡µÄ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥£‡µã?")) { customers[activeIndex].temp.splice(idx, 1); renderLive(); } }
    function resetTab() { if(confirm("‡¥ü‡¥æ‡¥¨‡µç ‡¥ï‡µç‡¥≤‡¥ø‡¥Ø‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥£‡µã?")) { customers[activeIndex].temp = []; renderLive(); } }

    function share() {
        let name = document.getElementById("customer").value || "User", data = customers[activeIndex].temp;
        if(data.length === 0) return;
        localStorage.setItem("recent_tab_data", JSON.stringify(data));
        let txt = `üìù ${name.toUpperCase()}\n------------------------------\n`, total = 0;
        data.forEach((item, index) => {
            txt += `${item.p.padEnd(3, ' ')}    ${item.n.padEnd(3, ' ')} - ${item.c}\n`;
            total += item.c;
        });
        txt += `------------------------------\n‚úÖ TOTAL : ${total}`;
        window.location.href = "whatsapp://send?text=" + encodeURIComponent(txt);
        customers[activeIndex].temp = []; renderLive();
    }

    function shareMerged() {
        let min = parseInt(document.getElementById("minLimit").value) || 0;
        let merged = {};
        permanent.forEach(item => {
            let key = item.p + "-" + item.n;
            if(merged[key]) merged[key].c += item.c;
            else merged[key] = { p: item.p, n: item.n, c: item.c };
        });
        let list = Object.values(merged).filter(i => i.c >= min).sort((a,b) => a.n.localeCompare(b.n));
        if(list.length === 0) { alert("‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥ï‡¥æ‡¥≤‡¥ø‡¥Ø‡¥æ‡¥£‡µç!"); return; }
        let txt = `üìä MERGED HISTORY\n------------------\n`, gt = 0;
        list.forEach(i => { txt += `${i.p} ${i.n} - ${i.c}\n`; gt += i.c; });
        txt += `------------------\nGT: ${gt}`;
        window.location.href = "whatsapp://send?text=" + encodeURIComponent(txt);
    }

    function renderSaved(merge = false) {
        let h = "", t = 0;
        let list = [...permanent];
        if(merge) {
            let m = {};
            list.forEach(i => { let k = i.p+"-"+i.n; if(m[k]) m[k].c += i.c; else m[k] = { p: i.p, n: i.n, c: i.c }; });
            list = Object.values(m).sort((a,b) => a.n.localeCompare(b.n));
        }
        list.slice().reverse().forEach(i => { 
            h += `<div class="item"><span class="item-text">${i.p} ${i.n} -- ${i.c}</span></div>`; 
            t += i.c; 
        });
        document.getElementById("savedList").innerHTML = h;
        document.getElementById("savedTotal").innerText = t;
    }

    function saveDay() { 
        if(customers[activeIndex].temp.length > 0) {
            permanent = [...permanent, ...customers[activeIndex].temp]; 
            localStorage.setItem("perm_list", JSON.stringify(permanent)); 
            alert("‡¥π‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡¥±‡¥ø ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!"); 
        }
    }

    function initTabs() {
        let h = "";
        customers.forEach((c, i) => h += `<div class="tab ${i === activeIndex ? 'active' : ''}" onclick="switchTab(${i})">${c.name || 'New'}</div>`);
        h += `<div class="tab" onclick="addNewCustomer()" style="background:var(--secondary);">+</div>`;
        document.getElementById("tabsList").innerHTML = h;
        document.getElementById("customer").value = customers[activeIndex].name;
        renderLive();
    }
    function switchTab(i) { activeIndex = i; initTabs(); }
    function addNewCustomer() { customers.push({name: "", temp: []}); activeIndex = customers.length - 1; initTabs(); }
    function updateTabName() { customers[activeIndex].name = document.getElementById("customer").value; localStorage.setItem("lottery_customers", JSON.stringify(customers)); initTabs(); }
    function toggleStepMode() { isStepMode = !isStepMode; document.getElementById("endNum").classList.toggle("hidden"); document.getElementById("gap").classList.toggle("hidden"); document.getElementById("stepToggle").innerText = isStepMode ? "NORMAL" : "STEP"; }
    function openHistory() { document.getElementById("mainPage").classList.add("hidden"); document.getElementById("historyPage").classList.remove("hidden"); renderSaved(); }
    function backToMain() { document.getElementById("historyPage").classList.add("hidden"); document.getElementById("mainPage").classList.remove("hidden"); }
    function clearAllHistory() { if(confirm("‡¥é‡¥≤‡µç‡¥≤‡¥æ‡¥Ç ‡¥ï‡µç‡¥≤‡¥ø‡¥Ø‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥£‡µã?")) { permanent=[]; localStorage.setItem("perm_list", "[]"); renderSaved(); } }
    function loadRecentTab() { let last = localStorage.getItem("recent_tab_data"); if(last) { customers[activeIndex].temp = JSON.parse(last); renderLive(); } }
    function boxEntry() { let n = document.getElementById("num").value, c = document.getElementById("count").value; if (n.length !== 3 || !c) return; let res = new Set(), p = (a, m = []) => { if (a.length === 0) res.add(m.join('')); else a.forEach((v, i) => { let cu = [...a]; cu.splice(i, 1); p(cu, [...m, v]); }); }; p(n.split('')); res.forEach(v => addManual("ABC", v, c)); document.getElementById("num").value = ""; document.getElementById("count").value = ""; }
    function scanImage(input) { if (input.files && input.files[0]) { Tesseract.recognize(input.files[0], 'eng').then(({ data: { text } }) => { let regex = /(\d{3})[^\d]+(\d+)/g, match; while ((match = regex.exec(text)) !== null) addManual("ABC", match[1], match[2]); }); } }
</script>
</body>
</html>
