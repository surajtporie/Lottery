<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lottery Pro Max - Advanced Step</title>
<style>
    :root { --bg: #121212; --card-bg: #1e1e1e; --text: #e0e0e0; --primary: #7b1fa2; --secondary: #00c853; --danger: #d32f2f; --border: #333; }
    body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 10px; }
    .card { width: 100%; max-width: 450px; background: var(--card-bg); border-radius: 15px; padding: 20px; box-sizing: border-box; }
    input, button, textarea { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #2c2c2c; color: white; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    button { font-weight: bold; cursor: pointer; border: none; text-transform: uppercase; }
    .tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 10px; }
    .tab { padding: 8px 15px; background: #333; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; }
    .tab.active { background: var(--primary); color: white; }
    .list { margin-top: 10px; max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: #181818; }
    .item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border); }
    .total-section { display: flex; justify-content: space-between; padding: 12px; background: #333; border-radius: 8px; margin-top: 10px; font-weight: bold; }
    .win-item { background: #1b5e20; color: #fff; margin-bottom: 2px; }
    .hidden { display: none !important; }
</style>
</head>
<body>

<div class="screen" id="mainPage">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:var(--primary);">Lottery Smart Pro</h3>
            <button onclick="resetTab()" style="width:auto; font-size:11px; background:var(--danger); padding:5px 10px;">RESET</button>
        </div>
        
        <div class="tabs" id="tabsList"></div>
        <input id="customer" placeholder="‡¥ï‡¥∏‡µç‡¥±‡µç‡¥±‡¥Æ‡µº ‡¥™‡µá‡¥∞‡µç" oninput="updateTabName()">
        
        <div class="row">
            <input id="num" placeholder="No" maxlength="3" type="tel">
            <input id="endNum" class="hidden" placeholder="End" maxlength="3" type="tel">
            <input id="gap" class="hidden" placeholder="Gap" type="tel" value="1">
            <input id="count" placeholder="Count" type="tel">
        </div>

        <div class="row">
            <button id="addBtn" style="background:var(--primary);" onclick="addEntry()">ADD</button>
            <button style="background:#546e7a;" onclick="boxEntry()">BOX</button>
            <button id="stepToggle" style="background:#4527a0;" onclick="toggleStepMode()">STEP</button>
        </div>

        <div class="list" id="liveList"></div>
        <div class="total-section"><span>GT</span><span id="liveTotal">0</span></div>
        
        <div class="row">
            <button style="background:#25D366;" onclick="share('live')">WHATSAPP</button>
            <button style="background:#2e7d32;" onclick="saveDay()">SAVE</button>
        </div>
        <button style="background:#455a64;" onclick="openHistory()">WIN CHECKER / HISTORY</button>
    </div>
</div>

<div class="screen hidden" id="historyPage">
    <div class="card">
        <h3>Saved History</h3>
        <textarea id="resultPaste" placeholder="‡¥±‡¥ø‡¥∏‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥™‡µá‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï..." style="height:80px;"></textarea>
        <button style="background:var(--secondary);" onclick="checkWinners()">CHECK WINNERS</button>
        
        <div id="winnerSection" class="hidden">
            <div id="winnerList" class="list"></div>
            <button style="background:#25D366;" onclick="shareWinners()">SHARE WINNERS</button>
        </div>

        <div class="row" style="margin-top:10px;">
            <button style="background:#673AB7;" onclick="renderSaved(true)">MERGE & SORT</button>
            <button style="background:var(--secondary);" onclick="shareMerged()">WA SHARE</button>
        </div>
        <div class="list" id="savedList"></div>
        <div class="total-section"><span>GT</span><span id="savedTotal">0</span></div>
        <button style="background:#555;" onclick="backToMain()">BACK</button>
    </div>
</div>

<script>
    let customers = JSON.parse(localStorage.getItem("lottery_customers")) || [{name: "", temp: []}];
    let activeIndex = 0;
    let permanent = JSON.parse(localStorage.getItem("perm_list")) || [];
    let mergedData = [];
    let isStepMode = false;

    // Focus switching
    document.getElementById("num").addEventListener("input", function() { 
        if(this.value.length === 3) {
            if(isStepMode) document.getElementById("endNum").focus();
            else document.getElementById("count").focus();
        }
    });
    document.getElementById("endNum").addEventListener("input", function() { if(this.value.length === 3) document.getElementById("gap").focus(); });
    document.getElementById("count").addEventListener("keypress", (e) => { if(e.key === "Enter") addEntry(); });

    function toggleStepMode() {
        isStepMode = !isStepMode;
        document.getElementById("endNum").classList.toggle("hidden");
        document.getElementById("gap").classList.toggle("hidden");
        let btn = document.getElementById("stepToggle");
        btn.innerText = isStepMode ? "NORMAL" : "STEP";
        btn.style.background = isStepMode ? "#d32f2f" : "#4527a0";
        document.getElementById("addBtn").innerText = isStepMode ? "ADD RANGE" : "ADD";
    }

    function addManual(n, c) {
        let formattedNum = n.toString().padStart(3, '0');
        customers[activeIndex].temp.push({n: formattedNum, c: Number(c), cust: customers[activeIndex].name || "No Name"});
        renderLive();
    }

    function addEntry() {
        let start = document.getElementById("num").value;
        let count = document.getElementById("count").value;

        if(!start || !count) return;

        if(isStepMode) {
            let end = document.getElementById("endNum").value;
            let gap = parseInt(document.getElementById("gap").value) || 1;
            if(!end) return;
            for(let i = parseInt(start); i <= parseInt(end); i += gap) {
                addManual(i, count);
            }
            toggleStepMode(); // Reset to normal after range add
        } else {
            addManual(start, count);
        }

        document.getElementById("num").value = "";
        document.getElementById("endNum").value = "";
        document.getElementById("count").value = "";
        document.getElementById("num").focus();
    }

    function boxEntry() {
        let n = document.getElementById("num").value, c = document.getElementById("count").value;
        if (n.length !== 3 || !c) return;
        let res = new Set();
        let p = (a, m = []) => { if (a.length === 0) res.add(m.join('')); else a.forEach((v, i) => { let cu = [...a]; cu.splice(i, 1); p(cu, [...m, v]); }); };
        p(n.split(''));
        res.forEach(v => addManual(v, c));
        document.getElementById("num").value = ""; document.getElementById("count").value = "";
    }

    function renderLive() {
        let h = "", t = 0;
        customers[activeIndex].temp.slice().reverse().forEach((item, i) => {
            h += `<div class="item"><span>${item.n} - (<b>${item.c}</b>)</span><button onclick="deleteEntry(${customers[activeIndex].temp.length-1-i})" style="color:red; background:none; border:none; font-size:18px;">‚ùå</button></div>`;
            t += Number(item.c);
        });
        document.getElementById("liveList").innerHTML = h || "<p style='text-align:center;'>No Data</p>";
        document.getElementById("liveTotal").innerText = t;
        localStorage.setItem("lottery_customers", JSON.stringify(customers));
    }

    function deleteEntry(idx) { 
        if(confirm("‡¥à ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥í‡¥¥‡¥ø‡¥µ‡¥æ‡¥ï‡µç‡¥ï‡¥£‡µã?")) {
            customers[activeIndex].temp.splice(idx, 1); 
            renderLive(); 
        }
    }

    function resetTab() { if(confirm("‡¥à ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥Æ‡µÅ‡¥¥‡µÅ‡¥µ‡¥®‡¥æ‡¥Ø‡¥ø ‡¥ï‡µç‡¥≤‡¥ø‡¥Ø‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥£‡µã?")) { customers[activeIndex].temp = []; renderLive(); } }

    function saveDay() { 
        if(customers[activeIndex].temp.length > 0) { 
            permanent = [...permanent, ...customers[activeIndex].temp]; 
            localStorage.setItem("perm_list", JSON.stringify(permanent)); 
            customers[activeIndex].temp = []; 
            renderLive(); 
            alert("History-‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!"); 
        } 
    }

    function checkWinners() {
        let raw = document.getElementById("resultPaste").value;
        let nums = raw.match(/\d{3}/g);
        if(!nums) return;
        let prizes = [5000, 500, 250, 100, 50];
        let prizeMap = {};
        nums.forEach((n, i) => { prizeMap[n] = (i < 5) ? prizes[i] : 20; });
        let wins = permanent.filter(e => prizeMap[e.n]);
        let h = "";
        wins.forEach(w => { h += `<div class="item win-item"><span><b>${w.n}</b> (${w.c}) - ${w.cust}</span><span>‚Çπ${prizeMap[w.n] * w.c}</span></div>`; });
        document.getElementById("winnerList").innerHTML = h || "‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ø‡¥ï‡µæ ‡¥á‡¥≤‡µç‡¥≤";
        document.getElementById("winnerSection").classList.remove("hidden");
    }

    function shareWinners() {
        let winContent = document.getElementById("winnerList").innerText;
        let txt = "üèÜ *WINNERS REPORT*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" + winContent;
        window.location.href = "whatsapp://send?text=" + encodeURIComponent(txt);
    }

    function renderSaved(merge = false) {
        let data = [...permanent];
        if (merge) {
            let obj = {}; 
            data.forEach(i => obj[i.n] = (obj[i.n] || 0) + Number(i.c));
            data = Object.entries(obj).map(([n, c]) => ({n, c, cust: "Merged"}));
            data.sort((a, b) => b.c - a.c); // Higher count first
            mergedData = data;
        }
        let h = "", t = 0;
        data.forEach(i => {
            h += `<div class="item"><span><b>${i.n}</b> - (${i.c})</span> <small>${i.cust}</small></div>`;
            t += Number(i.c);
        });
        document.getElementById("savedList").innerHTML = h;
        document.getElementById("savedTotal").innerText = t;
    }

    function shareMerged() {
        if(mergedData.length === 0) { alert("‡¥Ü‡¥¶‡µç‡¥Ø‡¥Ç Merge & Sort ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï"); return; }
        let min = prompt("Min Count:", "1");
        if(min === null) return;
        let filtered = mergedData.filter(i => i.c >= Number(min));
        let txt = `üìù *MERGED DATA*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        let total = 0;
        for (let i = 0; i < filtered.length; i += 2) {
            let i1 = filtered[i], i2 = filtered[i+1];
            txt += `*${i1.n}*=${i1.c}`; total += i1.c;
            if(i2) { txt += `  |  *${i2.n}*=${i2.c}\n`; total += i2.c; } else txt += `\n`;
        }
        txt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚úÖ *TOTAL : ${total}*`;
        window.location.href = "whatsapp://send?text=" + encodeURIComponent(txt);
    }

    function share(type) {
        let name = document.getElementById("customer").value || "User";
        let data = customers[activeIndex].temp;
        if(data.length === 0) return;
        let txt = `üìù *${name.toUpperCase()}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        let total = 0;
        for (let i = 0; i < data.length; i += 2) {
            let i1 = data[i], i2 = data[i+1];
            txt += `*${i1.n}*=${i1.c}`; total += Number(i1.c);
            if(i2) { txt += `  |  *${i2.n}*=${i2.c}\n`; total += Number(i2.c); } else txt += `\n`;
        }
        txt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚úÖ *TOTAL : ${total}*`;
        window.location.href = "whatsapp://send?text=" + encodeURIComponent(txt);
    }

    function openHistory() { document.getElementById("mainPage").classList.add("hidden"); document.getElementById("historyPage").classList.remove("hidden"); renderSaved(); }
    function backToMain() { document.getElementById("historyPage").classList.add("hidden"); document.getElementById("mainPage").classList.remove("hidden"); }
    function initTabs() {
        let h = "";
        customers.forEach((c, i) => h += `<div class="tab ${i === activeIndex ? 'active' : ''}" onclick="switchTab(${i})">${c.name || 'New'}</div>`);
        h += `<div class="tab" onclick="addNewCustomer()">+ Add</div>`;
        document.getElementById("tabsList").innerHTML = h;
        document.getElementById("customer").value = customers[activeIndex].name;
        renderLive();
    }
    function switchTab(i) { activeIndex = i; initTabs(); }
    function addNewCustomer() { customers.push({name: "", temp: []}); activeIndex = customers.length - 1; initTabs(); }
    function updateTabName() { customers[activeIndex].name = document.getElementById("customer").value; localStorage.setItem("lottery_customers", JSON.stringify(customers)); }
    initTabs();
</script>
</body>
</html>
